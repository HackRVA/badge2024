/*
 *  @author Peter Maxwell Warasila
 *  @date   April 10, 2024
 *
 *  @brief  RVASec 2024 Badge Audio Common Functions
 *
 *------------------------------------------------------------------------------
 *
 */

#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>
#include <stdlib.h>

#include <fxp_sqrt.h>

#include "audio.h"

/*- Private Constants --------------------------------------------------------*/
#define DB_RATIO_TABLE_ZERO_INDEX (86) /* Index of the entry for 0 dB. */
static const struct {int8_t dB; uint32_t ratio;} DB_RATIO_TABLE[] = 
{
    {INT8_MIN,     0},
    {-96,          1},
    {-90,          2},
    {-86,          3},
    {-84,          4},
    {-82,          5},
    {-80,          6},
    {-79,          7},
    {-78,          8},
    {-77,          9},
    {-76,         10},
    {-75,         11},
    {-74,         13},
    {-73,         14},
    {-72,         16},
    {-71,         18},
    {-70,         20},
    {-69,         23},
    {-68,         26},
    {-67,         29},
    {-66,         32},
    {-65,         36},
    {-64,         41},
    {-63,         46},
    {-62,         52},
    {-61,         58},
    {-60,         65},
    {-59,         73},
    {-58,         82},
    {-57,         92},
    {-56,        103},
    {-55,        116},
    {-54,        130},
    {-53,        146},
    {-52,        164},
    {-51,        184},
    {-50,        207},
    {-49,        232},
    {-48,        260},
    {-47,        292},
    {-46,        328},
    {-45,        368},
    {-44,        413},
    {-43,        463},
    {-42,        520},
    {-41,        584},
    {-40,        655},
    {-39,        735},
    {-38,        825},
    {-37,        925},
    {-36,       1038},
    {-35,       1165},
    {-34,       1307},
    {-33,       1467},
    {-32,       1646},
    {-31,       1847},
    {-30,       2072},
    {-29,       2325},
    {-28,       2609},
    {-27,       2927},
    {-26,       3284},
    {-25,       3685},
    {-24,       4135},
    {-23,       4639},
    {-22,       5205},
    {-21,       5840},
    {-20,       6553},
    {-19,       7353},
    {-18,       8250},
    {-17,       9257},
    {-16,      10386},
    {-15,      11654},
    {-14,      13076},
    {-13,      14671},
    {-12,      16461},
    {-11,      18470},
    {-10,      20724},
    { -9,      23253},
    { -8,      26090},
    { -7,      29273},
    { -6,      32845},
    { -5,      36853},
    { -4,      41350},
    { -3,      46395},
    { -2,      52057},
    { -1,      58409},
    {  0,      65536},
    {  1,      73532},
    {  2,      82504},
    {  3,      92572},
    {  4,     103867},
    {  5,     116541},
    {  6,     130761},
    {  7,     146716},
    {  8,     164618},
    {  9,     184705},
    { 10,     207243},
    { 11,     232530},
    { 12,     260903},
    { 13,     292738},
    { 14,     328458},
    { 15,     368536},
    { 16,     413504},
    { 17,     463959},
    { 18,     520570},
    { 19,     584090},
    { 20,     655360},
    { 21,     735326},
    { 22,     825049},
    { 23,     925720},
    { 24,    1038675},
    { 25,    1165413},
    { 26,    1307615},
    { 27,    1467168},
    { 28,    1646189},
    { 29,    1847055},
    { 30,    2072430},
    { 31,    2325305},
    { 32,    2609035},
    { 33,    2927385},
    { 34,    3284580},
    { 35,    3685360},
    { 36,    4135042},
    { 37,    4639593},
    { 38,    5205709},
    { 39,    5840902},
    { 40,    6553600},
    { 41,    7353260},
    { 42,    8250493},
    { 43,    9257206},
    { 44,   10386756},
    { 45,   11654131},
    { 46,   13076151},
    { 47,   14671682},
    { 48,   16461898},
    { 49,   18470554},
    { 50,   20724302},
    { 51,   23253050},
    { 52,   26090351},
    { 53,   29273855},
    { 54,   32845806},
    { 55,   36853601},
    { 56,   41350420},
    { 57,   46395934},
    { 58,   52057095},
    { 59,   58409021},
    { 60,   65536000},
    { 61,   73532601},
    { 62,   82504935},
    { 63,   92572060},
    { 64,  103867560},
    { 65,  116541319},
    { 66,  130761511},
    { 67,  146716828},
    { 68,  164618989},
    { 69,  184705543},
    { 70,  207243028},
    { 71,  232530502},
    { 72,  260903515},
    { 73,  292738558},
    { 74,  328458065},
    { 75,  368536010},
    { 76,  413504205},
    { 77,  463959349},
    { 78,  520570951},
    { 79,  584090214},
    { 80,  655360000},
    { 81,  735326014},
    { 82,  825049357},
    { 83,  925720605},
    { 84, 1038675602},
    { 85, 1165413194},
    { 86, 1307615110},
    { 87, 1467168285},
    { 88, 1646189891},
    { 89, 1847055437},
    { 90, 2072430287},
    { 91, 2325305027},
    { 92, 2609035152},
    { 93, 2927385589},
    { 94, 3284580654},
    { 95, 3685360108},
    { 96, 4135042052},
    {INT8_MAX, UINT32_MAX}, /* Guarantees UINT32_MAX in search domain. */
};

/*- Private Methods ----------------------------------------------------------*/
static uint32_t log2u32(uint32_t x)
{
    uint32_t n = 0;
    while (x >>= 1) {
        n++;
    }
    return n;
}

audio_sample_t audio_rms(const audio_sample_t *samples, size_t len)
{
    if (len == 0) {
        return 0;
    }

    uint32_t accum = 0;
    for (size_t i = 0; i < len; i++) {
        int32_t sample = samples[i];
        int32_t square = sample * sample;
        int32_t contribution = square / len;
        accum += contribution;
    }
    return sqrtu32(accum);
}

audio_sample_t audio_peak(const audio_sample_t *samples, size_t len)
{
    if (len == 0) {
        return 0;
    }

    audio_sample_t peak = 0;
    for (size_t i = 0; i < len; i++) { 
        audio_sample_t sample = abs(samples[i]);
        peak = peak < sample ? sample : peak;
    } 
    return peak;
}

int8_t audio_dB(audio_sample_t _ref, audio_sample_t _raw)
{
    /* Check some easy cases. */
    if (_ref == 0) {
        return INT8_MAX;
    } else if (_raw == 0) {
        return INT8_MIN;
    }

    /* Calculate the ratio as a 16.16 fixed precision integer. */
    uint32_t ref = _ref;
    uint32_t raw = _raw << 16;
    uint32_t ratio = raw / ref;

    /* Search the table. */
    size_t index;
    /* Start with a quick bisection. */
    if (ratio < (1 << 16)) {
        /* negative dB */
        index = 0;
    } else {
        /* positive dB */
        index = DB_RATIO_TABLE_ZERO_INDEX;
    }
    /* Scan upward through the table to find a ratio that is less or equal. */
    for (; DB_RATIO_TABLE[index].ratio < ratio; index++);
    return DB_RATIO_TABLE[index].dB;
}
